<html>
  <head>      
    <script language="javascript" src="processing.js"></script>
    <script language="javascript" src="init.js"></script>
  </head>
  <body>
    <script>
    // Setup shared variables
    var bufferSize = 512;
    var sampleRate = 44100.0;
    
    var signal = [];
    
    var fft;
    
    </script>
    
    <script target="#signal" type="application/processing">
    import('pjsaudio.lib.js');
    
    int harmonic = 1;
    float frequency = 345.0;
    float scale = 30.0;

    void setup() {
      size(bufferSize, 100);
      frameRate(10);
      
      fft = FFT(bufferSize, sampleRate);
      
      generateBaseSignal();
    }

    void draw() {
      background(0, 60);
      
      if (harmonic > 40 ) 
      {
        harmonic = 1;
        generateBaseSignal();
      }
      
      // Add harmonic
      if ( harmonic > 1 ) {
        for(int i = 0; i < bufferSize; i++) {
          float step = i * (frequency * harmonic / sampleRate) % 1;
          signal[i] += (float) Math.sin(TWO_PI * step) * (1 / harmonic);
        }
      }
      
      harmonic += 2; // 3rd, 5th, 7th, 9th, etc
     
      // Calculate forward transform
      fft.forward(signal);
      
      // Draw additive signal
      stroke(100, 255 - (2 * harmonic), 2 * harmonic);
      strokeWeight(1.5);
      
      for ( int i = 0; i < bufferSize - 1; i++ ) {
        line(i, scale + 10 - signal[i] * scale, i+1, scale + 10 - signal[i+1] * scale);
      }
    }
    
    void generateBaseSignal() {
      for(int i = 0; i < bufferSize; i++) {
        float step = i * (frequency / sampleRate) % 1;
        signal[i] = (float) Math.sin(TWO_PI * step);
      }
    }
    </script>
  
    <script target="#fft" type="application/processing">
    void setup() {
      size(bufferSize, 300);
    }
    
    void draw() {
      background(0);
      
      // Draw spectrum
      stroke(255);
      strokeWeight(1.5);
      
      for ( int i = 0; i < fft.spectrum.length - 1; i++ ) {
        line(2*i, height - 10 - fft.spectrum[i] * bufferSize, 2*i+1, height - 10 - fft.spectrum[i+1] * bufferSize);
      }
    } 
    </script>
    
    <h1>Building a Square wave</h1>
    <p>Any complex waveform can be made up of simple sinusoids.</p>
    <p>A square wave is made by first starting with a sine wave then adding every other nth harmonic at frequency nth * the base frequency and amplitude of 1/n</p>
    <p>FFT breaks down a waveform into its sinusoidal components to measure the amplitude of the frequencies.</p> 
    
    <b>1.</b> Additive sine waves combine to form a complex square wave.
    <div><canvas id="signal" width="200px" height="200px"></canvas></div>
    <b>2.</b> The FFT graphs the harmonics frequencies as the square wave takes form.
    <div><canvas id="fft" width="200px" height="200px"></canvas></div>
  </body>
</html>
